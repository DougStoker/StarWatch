<html>

<head>
<title>Night Watch</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
    canvas {
        border:1px solid rgb(199, 241, 237);
        position: absolute; 
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    </style>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js' ></script>

</head>

<body onload="startGame()">

    <header style= "text-align: center; font-size: bolder; color: rgb(199, 241, 237)">Night Watch</header>
    
    <script>
       

       
        //var myGamePiece;
        let myUUID = uuidv4();
        var gamePieces = { };
        let myColor = getRandomColor();

        //var socket = io('//:3000') // for localhost testing
        var socket = io('https://nightwatch-sohysxkggn.now.sh')
        socket.on('announce', () => {
            //console.log("announce received")
            var myGamePiece = gamePieces[myUUID];
            socket.emit('move',{ uuid: myUUID, x: myGamePiece.x, y: myGamePiece.y, color: myColor });
        })
        socket.on('moved', function(data) {
            //console.log("move received:");
            //console.log(data);
            // This is where we parse the data object for the new box to draw
            if (typeof gamePieces[data.uuid] != "undefined") {
                gamePieces[data.uuid].x = data.x;
                gamePieces[data.uuid].y = data.y;
            } else {
                gamePieces[data.uuid] = new component(30, 30, data.color, data.x, data.y);
            }
            // socket.emit('moved')
        });
        socket.on('remove', function(data) {
            // We should make some pretty animation here
            if (typeof gamePieces[data.uuid] != 'undefined') {
                delete gamePieces[data.uuid];
            }
        })



        var myGameArea = {
         canvas : document.createElement("canvas"), 
         start : function() {
            this.canvas.width = 1225;
            this.canvas.height = 550;
            this.context = this.canvas.getContext("2d");
            document.body.insertBefore(this.canvas, document.body.childNodes[0]);
            document.body.style.backgroundImage = "url('https://d2v9y0dukr6mq2.cloudfront.net/video/thumbnail/Hme4C4_7iosf3emf/stars-in-the-sky-looped-animation-beautiful-night-with-twinkling-flares-hd-1080_sr8wih9v__F0000.png')";
            this.interval = setInterval(updateGameArea, getRandomInt(25,5));
            this.interval2 = setInterval(updateRefresh, getRandomInt(5000,1000));
            window.addEventListener('keydown', function (e) {
             myGameArea.keys = (myGameArea.keys || []);
             myGameArea.keys[e.keyCode] = true;
             e.preventDefault();
            })
            window.addEventListener('keyup', function (e) {
             myGameArea.keys[e.keyCode] = false;
            })
         },
         clear : function() {
             this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
         }
        }

        function updateRefresh() {
            clearInterval(myGameArea.interval);
            clearInterval(myGameArea.interval2);
            myGameArea.interval = setInterval(updateGameArea, getRandomInt(25,5));
            myGameArea.interval2 = setInterval(updateRefresh, getRandomInt(5000,1000));
        }

        function startGame() {
             myGameArea.start();
             gamePieces[myUUID] = new component(30, 30, myColor, 595, 20);
             socket.emit('move',{ uuid: myUUID, x: gamePieces[myUUID].x, y: gamePieces[myUUID].y, color: myColor });
        }

        function component(width, height, color, x, y) {
         this.width = width;
         this.height = height;
         this.speedX = 0;
         this.speedY = 0;
         this.x = x;
         this.y = y;    
         this.update = function() {
             ctx = myGameArea.context;
             ctx.fillStyle = color;
             ctx.fillRect(this.x, this.y, this.width, this.height);
         }
         this.newPos = function() {
             this.x += this.speedX;
             this.y += this.speedY; 
         } 
        }

        function updateGameArea() {
            myGameArea.clear();
            var myGamePiece = gamePieces[myUUID];
            myGamePiece.speedX = 0;
            myGamePiece.speedY = 0; 
            if (myGameArea.keys && myGameArea.keys [37]) {myGamePiece.speedX = -1; }
            if (myGameArea.keys && myGameArea.keys [39]) {myGamePiece.speedX = 1; }
            if (myGameArea.keys && myGameArea.keys [38]) {myGamePiece.speedY = -1; }
            if (myGameArea.keys && myGameArea.keys [40]) {myGamePiece.speedY = 1; }

            if (myGamePiece.speedX != 0 || myGamePiece.speedY != 0) {
                socket.emit('move',{ uuid: myUUID, x: myGamePiece.x, y: myGamePiece.y, color: myColor });
            }     

            myGamePiece.newPos();

            for (var uuid in gamePieces) {
                gamePieces[uuid].update();
            }
        }

        function uuidv4() {
          return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,        function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
           });
        }
        
        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function getRandomInt(max,min) {
            if (min == null || min == undefined) { min = 0 }
            return Math.floor(Math.random() * Math.floor(max-min) + min)
        }

    </script> 
    
</body>
</html>